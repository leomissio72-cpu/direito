<!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --sidebar:#0f1724;
      --card:#ffffff;
      --muted:#556179;
      --primary:#3366ff;
      --accent:#2b61ff;
      --success:#0ea44e;
      --warning:#f59e0b;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:#0b1b2b}
    .app{display:flex;min-height:100vh}

    /* SIDEBAR */
    .sidebar{
      width:220px;padding:20px;background:#0f1724;color:#fff;display:flex;flex-direction:column;gap:18px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .brand h3{margin:0;font-size:16px}
    nav{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .nav-btn{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;border:none;background:transparent;color:rgba(255,255,255,0.9);cursor:pointer;font-weight:600;text-align:left;width:100%}
    .nav-btn:hover{background:rgba(255,255,255,0.04)}
    .nav-btn.active{background:rgba(255,255,255,0.06)}
    .sidebar-footer{margin-top:auto;color:var(--muted);font-size:13px}

    /* WORKSPACE */
    .workspace{flex:1;display:flex;flex-direction:column;min-width:0}
    .topbar{height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:transparent;border-bottom:1px solid rgba(16,24,40,0.04)}
    .page-title{font-size:18px;font-weight:700;color:#0b1b2b}
    .user-area{display:flex;align-items:center;gap:12px}
    .avatar{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}

    .main-area{padding:18px;overflow:auto}
    .container{background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(11,27,43,0.04);box-shadow:0 8px 24px rgba(11,27,43,0.04);margin-bottom:16px}
    h2{margin:0 0 8px 0;color:#0b1b2b}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .col-full{grid-column:1/-1}
    label{display:block;margin-top:10px;color:var(--muted);font-weight:600;font-size:13px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(11,27,43,0.06);background:#fff;color:#0b1b2b;font-family:'Inter',sans-serif;font-size:14px}
    textarea{min-height:100px;resize:vertical}
    .actions{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700;font-size:14px;transition:opacity 0.2s}
    .btn:hover{opacity:0.9}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(11,27,43,0.06);color:#0b1b2b}
    .btn.link{background:transparent;color:var(--muted);text-decoration:underline;padding:8px}
    .btn.danger{background:var(--danger);color:#fff}

    table{width:100%;border-collapse:collapse;margin-top:12px;color:#0b1b2b}
    th,td{padding:10px;border-bottom:1px solid rgba(11,27,43,0.04);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:700}
    td .btn{padding:6px 10px;font-size:13px}
    td select{padding:6px 8px;font-size:13px;border:1px solid rgba(11,27,43,0.1)}

    .no-data{color:var(--muted);padding:18px;text-align:center}
    .note-card{background:#fafbff;border-left:4px solid var(--primary);padding:12px;border-radius:8px;margin-bottom:10px}
    .note-meta{font-size:13px;color:var(--muted);margin-bottom:6px}
    .note-text{font-size:14px;color:#0b1b2b}

    .alert{padding:12px 16px;border-radius:8px;margin-bottom:12px;font-size:14px}
    .alert.success{background:#d1fae5;color:#065f46;border:1px solid #10b981}
    .alert.error{background:#fee2e2;color:#991b1b;border:1px solid #ef4444}

    .status-badge{
      display:inline-block;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;
    }
    .status-aguardando{background:#fef3c7;color:#92400e}
    .status-andamento{background:#dbeafe;color:#1e40af}
    .status-suspenso{background:#fed7aa;color:#9a3412}
    .status-sentenca{background:#e9d5ff;color:#6b21a8}
    .status-recurso{background:#fce7f3;color:#9f1239}
    .status-arquivado{background:#e5e7eb;color:#374151}
    .status-finalizado{background:#d1fae5;color:#065f46}

    /* LOGIN MODAL */
    .login-modal{
      position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);
      display:flex;align-items:center;justify-content:center;z-index:9999;
    }
    .login-card{
      background:var(--card);border-radius:12px;padding:32px;max-width:400px;width:90%;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
    }
    .login-card h2{margin-top:0;text-align:center}
    .login-card p{text-align:center;color:var(--muted);margin-bottom:24px}
    .google-btn-wrapper{display:flex;justify-content:center;margin-top:16px}
    .skip-login{text-align:center;margin-top:16px}
    .skip-login button{background:transparent;border:none;color:var(--muted);
      text-decoration:underline;cursor:pointer;font-size:14px}
    .user-profile{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;
      border-radius:8px;transition:background 0.2s}
    .user-profile:hover{background:rgba(11,27,43,0.04)}
    .user-profile img{width:40px;height:40px;border-radius:8px}
    .user-dropdown{position:absolute;top:60px;right:20px;background:var(--card);
      border-radius:8px;padding:8px;box-shadow:0 8px 24px rgba(11,27,43,0.1);
      border:1px solid rgba(11,27,43,0.04);min-width:200px;display:none}
    .user-dropdown.show{display:block}
    .user-dropdown-item{padding:10px;cursor:pointer;border-radius:6px;
      display:flex;align-items:center;gap:8px;transition:background 0.2s}
    .user-dropdown-item:hover{background:rgba(11,27,43,0.04)}

    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
      .sidebar{width:64px}
      .brand h3,.sidebar-footer{display:none}
      .nav-btn .label{display:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">J</div>
        <div>
          <h3>Sistema Jur√≠dico</h3>
          <div style="font-size:12px;color:var(--muted)">Escrit√≥rio</div>
        </div>
      </div>

      <nav>
        <button class="nav-btn active" data-tab="cadastro">
          <span class="material-icons">person_add</span>
          <span class="label">Cadastro</span>
        </button>
        <button class="nav-btn" data-tab="lista">
          <span class="material-icons">folder_open</span>
          <span class="label">Processos</span>
        </button>
        <button class="nav-btn" data-tab="anotacoes">
          <span class="material-icons">note_add</span>
          <span class="label">Anota√ß√µes</span>
        </button>
        <button class="nav-btn" data-tab="ferramentas">
          <span class="material-icons">build</span>
          <span class="label">Ferramentas</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        <div style="font-size:12px;margin-top:8px">
          <strong>Armazenamento:</strong> Local
        </div>
        <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px">
          Os dados s√£o salvos no navegador
        </div>
      </div>
    </aside>

    <!-- WORKSPACE -->
    <div class="workspace">
      <div class="topbar">
        <div class="page-title" id="pageTitle">Cadastro</div>
        <div class="user-area" id="userArea">
          <div style="text-align:right">
            <div id="userName" style="font-weight:700">Sistema Local</div>
            <div style="font-size:12px;color:var(--muted)">
              <span id="userStatus">Armazenamento do navegador</span>
              <button id="btnLogin" style="background:transparent;border:none;color:var(--primary);cursor:pointer;text-decoration:underline;font-size:12px;margin-left:8px">
                Fazer Login
              </button>
            </div>
          </div>
          <div class="avatar" id="userAvatar">‚öñÔ∏è</div>
        </div>
        <div class="user-dropdown" id="userDropdown">
          <div class="user-dropdown-item" onclick="signOut()">
            <span class="material-icons" style="font-size:18px">logout</span>
            Sair
          </div>
        </div>
      </div>

      <main class="main-area">
        <!-- CADASTRO -->
        <section id="cadastro" class="container tab" style="display:block">
          <h2>Cadastro de Cliente & Processo</h2>
          <div id="alertCadastro"></div>
          <form id="formCadastro" style="margin-top:12px">
            <div class="grid">
              <div>
                <label>Nome completo *</label>
                <input name="nome" type="text" required placeholder="Ex: Jos√© da Silva">

                <label>CPF</label>
                <input name="cpf" type="text" placeholder="000.000.000-00">

                <label>RG</label>
                <input name="rg" type="text" placeholder="">
              </div>

              <div>
                <label>Telefone / WhatsApp</label>
                <input name="telefone" type="text" placeholder="(11) 9xxxx-xxxx">

                <label>E-mail</label>
                <input name="email" type="email" placeholder="exemplo@dominio.com">

                <label>Respons√°vel (advogado)</label>
                <input name="responsavel" type="text" placeholder="Adv. Fulano">
              </div>

              <div class="col-full">
                <label>Endere√ßo</label>
                <input name="endereco" type="text" placeholder="Rua, n¬∫, bairro, cidade - UF">
              </div>

              <div>
                <label>Categoria do processo</label>
                <select name="categoria">
                  <option value="">Selecione...</option>
                  <option value="C√≠vel">C√≠vel</option>
                  <option value="Trabalhista">Trabalhista</option>
                  <option value="Penal">Penal</option>
                  <option value="Fam√≠lia">Fam√≠lia</option>
                  <option value="Consumidor">Consumidor</option>
                  <option value="Tribut√°rio">Tribut√°rio</option>
                  <option value="Administrativo">Administrativo</option>
                  <option value="Previdenci√°rio">Previdenci√°rio</option>
                  <option value="Outros">Outros</option>
                </select>

                <label>N√∫mero do processo</label>
                <input name="numero" type="text" placeholder="0001234-56.2025.8.26.0000">
              </div>

              <div>
                <label>Vara / Comarca</label>
                <input name="vara" type="text" placeholder="Ex: 3¬™ Vara C√≠vel de S√£o Paulo">

                <label>Parte Contr√°ria</label>
                <input name="parte" type="text" placeholder="Nome da parte contr√°ria">
              </div>

              <div>
                <label>Status do Processo</label>
                <select name="status">
                  <option value="Aguardando Distribui√ß√£o">Aguardando Distribui√ß√£o</option>
                  <option value="Em Andamento">Em Andamento</option>
                  <option value="Aguardando Decis√£o">Aguardando Decis√£o</option>
                  <option value="Suspenso">Suspenso</option>
                  <option value="Senten√ßa Proferida">Senten√ßa Proferida</option>
                  <option value="Em Recurso">Em Recurso</option>
                  <option value="Tr√¢nsito em Julgado">Tr√¢nsito em Julgado</option>
                  <option value="Arquivado">Arquivado</option>
                  <option value="Finalizado">Finalizado</option>
                </select>

                <label>Data de abertura</label>
                <input name="dataAbertura" type="date">
              </div>

              <div>
                <label>Valor da causa (R$)</label>
                <input name="valor" type="number" step="0.01" placeholder="0.00">

                <label>Honor√°rios (R$)</label>
                <input name="honorarios" type="number" step="0.01" placeholder="0.00">
              </div>

              <div>
                <label>Forma de Pagamento</label>
                <select name="formaPagamento" id="formaPagamento">
                  <option value="">Selecione...</option>
                  <option value="√Ä Vista">√Ä Vista</option>
                  <option value="Parcelado">Parcelado</option>
                  <option value="Sucumb√™ncia">Sucumb√™ncia</option>
                  <option value="√äxito">√äxito (% sobre ganho)</option>
                  <option value="Pro Bono">Pro Bono</option>
                  <option value="Conv√™nio">Conv√™nio</option>
                </select>

                <label>Quantidade de Parcelas</label>
                <input name="parcelas" type="number" min="1" placeholder="Ex: 12" id="parcelasInput">
              </div>

              <div class="col-full">
                <label>Observa√ß√µes / Anota√ß√µes</label>
                <textarea name="observacoes" placeholder="Anota√ß√µes importantes, prazos, lembretes..."></textarea>
              </div>
            </div>

            <div class="actions">
              <button class="btn primary" type="submit">
                <span class="material-icons">save</span> Salvar Processo
              </button>
              <button type="button" class="btn ghost" id="btnExportPdf">
                <span class="material-icons">picture_as_pdf</span> Exportar PDF
              </button>
              <button type="button" class="btn link" id="btnLimparForm">
                Limpar Formul√°rio
              </button>
            </div>
          </form>
        </section>

        <!-- LISTA -->
        <section id="lista" class="container tab" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
            <h2>Processos Registrados</h2>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input id="searchInput" placeholder="Pesquisar..." style="padding:8px;border-radius:8px;border:1px solid rgba(11,27,43,0.06);min-width:200px">
              <button class="btn ghost" id="btnRefresh">
                <span class="material-icons">refresh</span> Atualizar
              </button>
              <button class="btn ghost" id="btnDownloadCsv">
                <span class="material-icons">download</span> CSV
              </button>
              <button class="btn ghost" id="btnSortDate">
                <span class="material-icons">sort</span> Data
              </button>
            </div>
          </div>

          <div id="tableWrapper" style="margin-top:12px;overflow-x:auto">
            <div class="no-data">Carregando registros...</div>
          </div>
        </section>

        <!-- ANOTA√á√ïES -->
        <section id="anotacoes" class="container tab" style="display:none">
          <h2>Anota√ß√µes</h2>
          <div id="alertAnotacoes"></div>

          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
            <div style="flex:1;min-width:220px">
              <label>Processo (selecionar)</label>
              <select id="selectProcesso" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(11,27,43,0.06);background:#fff;color:#0b1b2b">
                <option value="">--- selecione um processo ---</option>
              </select>
            </div>

            <div style="flex:1;min-width:220px">
              <label>Adicionar anota√ß√£o</label>
              <input id="inputAnotacao" placeholder="Digite a anota√ß√£o..." style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(11,27,43,0.06);background:#fff;color:#0b1b2b">
            </div>

            <div style="display:flex;align-items:end">
              <button class="btn primary" id="btnSalvarAnotacao">
                <span class="material-icons">note_add</span> Salvar
              </button>
            </div>
          </div>

          <div id="listaAnotacoes"></div>
        </section>

        <!-- FERRAMENTAS -->
        <section id="ferramentas" class="container tab" style="display:none">
          <h2>Calculadora de Prazos Processuais</h2>
          
          <div class="grid" style="margin-top:12px">
            <div>
              <label>Data Inicial</label>
              <input type="date" id="dataInicial">
              
              <label>Tipo de Prazo</label>
              <select id="tipoPrazo">
                <option value="corrido">Dias Corridos</option>
                <option value="uteis">Dias √öteis</option>
              </select>
            </div>

            <div>
              <label>Quantidade de Dias</label>
              <input type="number" id="quantidadeDias" placeholder="Ex: 15" min="1">
              
              <label style="visibility:hidden">Espa√ßo</label>
              <button class="btn primary" id="btnCalcularPrazo" style="width:100%">
                <span class="material-icons">calculate</span> Calcular
              </button>
            </div>

            <div class="col-full" id="resultadoPrazo" style="display:none;background:#fafbff;padding:16px;border-radius:8px;border:2px solid var(--primary)">
              <div style="font-weight:700;color:var(--primary);margin-bottom:8px">Resultado:</div>
              <div id="resultadoTexto" style="font-size:16px;color:#0b1b2b"></div>
            </div>
          </div>

          <hr style="margin:24px 0;border:none;border-top:1px solid rgba(11,27,43,0.06)">

          <h2 style="margin-top:24px">Gerenciar Dados</h2>
          <div style="margin-top:12px">
            <button class="btn danger" id="btnLimparTodos">
              <span class="material-icons">delete_forever</span> Limpar Todos os Dados
            </button>
            <p style="color:var(--muted);margin-top:8px;font-size:13px">
              Aten√ß√£o: Esta a√ß√£o remover√° todos os processos e anota√ß√µes salvos. N√£o √© poss√≠vel desfazer.
            </p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="login-modal" id="loginModal" style="display:none">
    <div class="login-card">
      <h2>üîê Login com Google</h2>
      <p>Fa√ßa login com sua conta Google para sincronizar seus dados e acessar de qualquer dispositivo.</p>
      
      <div style="background:#fff3cd;border:1px solid #ffc107;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px">
        <strong>‚ö†Ô∏è Configura√ß√£o Necess√°ria:</strong><br>
        Para usar o login do Google, voc√™ precisa:
        <ol style="margin:8px 0 0 0;padding-left:20px">
          <li>Criar um projeto no <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
          <li>Ativar a Google Identity Services API</li>
          <li>Criar credenciais OAuth 2.0</li>
          <li>Inserir seu Client ID abaixo</li>
        </ol>
      </div>

      <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px">
        Google Client ID:
      </label>
      <input 
        type="text" 
        id="googleClientId" 
        placeholder="SEU-CLIENT-ID.apps.googleusercontent.com"
        style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(11,27,43,0.1);margin-bottom:16px;font-size:13px"
      >
      <button class="btn primary" onclick="saveClientIdAndInitGoogle()" style="width:100%">
        <span class="material-icons">save</span> Salvar e Continuar
      </button>
      
      <div id="googleButtonContainer" class="google-btn-wrapper" style="display:none">
        <!-- Google Button will appear here -->
        <div id="g_id_onload"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="signin_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>
      </div>

      <div class="skip-login">
        <button onclick="skipLogin()">Continuar sem login (usar apenas armazenamento local)</button>
      </div>
    </div>
  </div>

  <script>
    // ========== GOOGLE LOGIN CONFIGURATION ==========
    const GOOGLE_CLIENT_ID_KEY = 'google_client_id';
    const GOOGLE_USER_KEY = 'google_user_info';
    let currentUser = null;

    // Decode JWT token
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
          atob(base64)
            .split('')
            .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
            .join('')
        );
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error('Error parsing JWT:', e);
        return null;
      }
    }

    // Handle Google Sign-In Response
    function handleCredentialResponse(response) {
      console.log("Google login successful!");
      const userInfo = parseJwt(response.credential);
      
      if (userInfo) {
        currentUser = {
          name: userInfo.name,
          email: userInfo.email,
          picture: userInfo.picture,
          id: userInfo.sub,
          token: response.credential
        };
        
        // Save to sessionStorage
        sessionStorage.setItem(GOOGLE_USER_KEY, JSON.stringify(currentUser));
        
        // Update UI
        updateUserUI();
        
        // Hide login modal
        document.getElementById('loginModal').style.display = 'none';
      }
    }

    // Save Client ID and Initialize Google
    function saveClientIdAndInitGoogle() {
      const clientId = document.getElementById('googleClientId').value.trim();
      
      if (!clientId) {
        alert('Por favor, insira um Client ID v√°lido.');
        return;
      }
      
      if (!clientId.includes('.apps.googleusercontent.com')) {
        alert('O Client ID deve estar no formato: SEU-ID.apps.googleusercontent.com');
        return;
      }
      
      // Save to localStorage
      localStorage.setItem(GOOGLE_CLIENT_ID_KEY, clientId);
      
      // Show Google button
      document.getElementById('googleButtonContainer').style.display = 'flex';
      
      // Initialize Google Sign-In
      try {
        google.accounts.id.initialize({
          client_id: clientId,
          callback: handleCredentialResponse
        });
        
        google.accounts.id.renderButton(
          document.querySelector('.g_id_signin'),
          { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" }
        );
        
        alert('‚úÖ Configura√ß√£o salva! Agora voc√™ pode fazer login com Google.');
      } catch (e) {
        console.error('Error initializing Google Sign-In:', e);
        alert('Erro ao inicializar Google Sign-In. Verifique se o Client ID est√° correto.');
      }
    }

    // Skip Login
    function skipLogin() {
      document.getElementById('loginModal').style.display = 'none';
      sessionStorage.setItem('skip_login', 'true');
    }

    // Sign Out
    function signOut() {
      if (confirm('Deseja realmente sair?')) {
        currentUser = null;
        sessionStorage.removeItem(GOOGLE_USER_KEY);
        sessionStorage.removeItem('google_token');
        
        // Reset UI
        document.getElementById('userName').textContent = 'Sistema Local';
        document.getElementById('userStatus').textContent = 'Armazenamento do navegador';
        document.getElementById('userAvatar').innerHTML = '‚öñÔ∏è';
        document.getElementById('btnLogin').style.display = 'inline';
        document.getElementById('userDropdown').classList.remove('show');
        
        // Disable Google auto-select
        if (typeof google !== 'undefined' && google.accounts) {
          google.accounts.id.disableAutoSelect();
        }
      }
    }

    // Update User UI
    function updateUserUI() {
      if (currentUser) {
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userStatus').textContent = currentUser.email;
        document.getElementById('btnLogin').style.display = 'none';
        
        // Update avatar
        const avatarEl = document.getElementById('userAvatar');
        avatarEl.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width:40px;height:40px;border-radius:8px">`;
        
        // Make avatar clickable
        avatarEl.style.cursor = 'pointer';
        avatarEl.onclick = () => {
          document.getElementById('userDropdown').classList.toggle('show');
        };
      }
    }

    // Show Login Modal
    function showLoginModal() {
      const savedClientId = localStorage.getItem(GOOGLE_CLIENT_ID_KEY);
      
      if (savedClientId) {
        document.getElementById('googleClientId').value = savedClientId;
        // Auto-initialize if Client ID exists
        setTimeout(() => {
          document.getElementById('googleButtonContainer').style.display = 'flex';
          try {
            google.accounts.id.initialize({
              client_id: savedClientId,
              callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
              document.querySelector('.g_id_signin'),
              { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" }
            );
          } catch (e) {
            console.error('Error initializing Google:', e);
          }
        }, 500);
      }
      
      document.getElementById('loginModal').style.display = 'flex';
    }

    // Check if user is logged in on page load
    window.addEventListener('load', () => {
      const savedUser = sessionStorage.getItem(GOOGLE_USER_KEY);
      const skipLogin = sessionStorage.getItem('skip_login');
      
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          // Check if token is still valid
          const tokenData = parseJwt(currentUser.token);
          if (tokenData && tokenData.exp * 1000 > Date.now()) {
            updateUserUI();
          } else {
            // Token expired
            sessionStorage.removeItem(GOOGLE_USER_KEY);
          }
        } catch (e) {
          console.error('Error loading user:', e);
        }
      } else if (!skipLogin) {
        // Show login modal if not logged in and not skipped
        setTimeout(showLoginModal, 1000);
      }
    });

    // Login button click
    document.getElementById('btnLogin').addEventListener('click', showLoginModal);

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('userDropdown');
      const avatar = document.getElementById('userAvatar');
      if (!dropdown.contains(e.target) && !avatar.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    // ========== OP√á√ïES DE STATUS ==========
    const STATUS_OPTIONS = [
      'Aguardando Distribui√ß√£o',
      'Em Andamento',
      'Aguardando Decis√£o',
      'Suspenso',
      'Senten√ßa Proferida',
      'Em Recurso',
      'Tr√¢nsito em Julgado',
      'Arquivado',
      'Finalizado'
    ];

    // ========== ARMAZENAMENTO ==========
    const DB_KEY = 'processos_juridicos';
    const NOTES_KEY = 'anotacoes_juridicas';

    function salvarProcessos(processos) {
      localStorage.setItem(DB_KEY, JSON.stringify(processos));
    }

    function carregarProcessos() {
      const data = localStorage.getItem(DB_KEY);
      return data ? JSON.parse(data) : [];
    }

    function salvarAnotacoes(anotacoes) {
      localStorage.setItem(NOTES_KEY, JSON.stringify(anotacoes));
    }

    function carregarAnotacoes() {
      const data = localStorage.getItem(NOTES_KEY);
      return data ? JSON.parse(data) : [];
    }

    // ========== CONTROLE DE PARCELAS ==========
    document.getElementById('formaPagamento').addEventListener('change', (e) => {
      const parcelasInput = document.getElementById('parcelasInput');
      if (e.target.value === 'Parcelado') {
        parcelasInput.disabled = false;
        parcelasInput.required = true;
      } else {
        parcelasInput.disabled = true;
        parcelasInput.required = false;
        parcelasInput.value = '';
      }
    });

    // ========== NAVEGA√á√ÉO ENTRE ABAS ==========
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        // Atualizar bot√µes ativos
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Mostrar aba correspondente
        document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
        document.getElementById(tab).style.display = 'block';
        
        // Atualizar t√≠tulo
        const titulos = {
          'cadastro': 'Cadastro',
          'lista': 'Processos Registrados',
          'anotacoes': 'Anota√ß√µes',
          'ferramentas': 'Ferramentas'
        };
        document.getElementById('pageTitle').textContent = titulos[tab];
        
        // Atualizar lista se for aba de processos
        if (tab === 'lista') {
          renderizarTabela();
        }
        
        // Atualizar anota√ß√µes
        if (tab === 'anotacoes') {
          atualizarSelectProcessos();
          renderizarAnotacoes();
        }
      });
    });

    // ========== FORMUL√ÅRIO DE CADASTRO ==========
    document.getElementById('formCadastro').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const processo = {
        id: Date.now().toString(),
        dataCadastro: new Date().toISOString(),
        nome: formData.get('nome'),
        cpf: formData.get('cpf'),
        rg: formData.get('rg'),
        telefone: formData.get('telefone'),
        email: formData.get('email'),
        responsavel: formData.get('responsavel'),
        endereco: formData.get('endereco'),
        categoria: formData.get('categoria'),
        numero: formData.get('numero'),
        vara: formData.get('vara'),
        parte: formData.get('parte'),
        status: formData.get('status'),
        dataAbertura: formData.get('dataAbertura'),
        valor: formData.get('valor'),
        honorarios: formData.get('honorarios'),
        formaPagamento: formData.get('formaPagamento'),
        parcelas: formData.get('parcelas'),
        observacoes: formData.get('observacoes')
      };
      
      const processos = carregarProcessos();
      processos.push(processo);
      salvarProcessos(processos);
      
      mostrarAlerta('alertCadastro', 'Processo salvo com sucesso!', 'success');
      e.target.reset();
      document.getElementById('parcelasInput').disabled = true;
      
      setTimeout(() => {
        document.getElementById('alertCadastro').innerHTML = '';
      }, 3000);
    });

    // Limpar formul√°rio
    document.getElementById('btnLimparForm').addEventListener('click', () => {
      document.getElementById('formCadastro').reset();
      document.getElementById('parcelasInput').disabled = true;
    });

    // ========== EXPORTAR PDF ==========
    document.getElementById('btnExportPdf').addEventListener('click', () => {
      const form = document.getElementById('formCadastro');
      const formData = new FormData(form);
      
      if (!formData.get('nome')) {
        alert('Preencha pelo menos o nome do cliente para exportar.');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.text('Cadastro de Processo - Sistema Jur√≠dico', 20, 20);
      
      doc.setFontSize(12);
      let y = 40;
      
      const campos = [
        ['Nome', formData.get('nome')],
        ['CPF', formData.get('cpf')],
        ['RG', formData.get('rg')],
        ['Telefone', formData.get('telefone')],
        ['E-mail', formData.get('email')],
        ['Respons√°vel', formData.get('responsavel')],
        ['Endere√ßo', formData.get('endereco')],
        ['Categoria', formData.get('categoria')],
        ['N√∫mero do Processo', formData.get('numero')],
        ['Vara/Comarca', formData.get('vara')],
        ['Parte Contr√°ria', formData.get('parte')],
        ['Status', formData.get('status')],
        ['Data de Abertura', formData.get('dataAbertura')],
        ['Valor da Causa', formData.get('valor') ? `R$ ${formData.get('valor')}` : ''],
        ['Honor√°rios', formData.get('honorarios') ? `R$ ${formData.get('honorarios')}` : ''],
        ['Forma de Pagamento', formData.get('formaPagamento')],
        ['Parcelas', formData.get('parcelas')],
      ];
      
      campos.forEach(([label, value]) => {
        if (value) {
          doc.setFont(undefined, 'bold');
          doc.text(`${label}:`, 20, y);
          doc.setFont(undefined, 'normal');
          doc.text(value, 70, y);
          y += 10;
        }
      });
      
      if (formData.get('observacoes')) {
        y += 5;
        doc.setFont(undefined, 'bold');
        doc.text('Observa√ß√µes:', 20, y);
        y += 7;
        doc.setFont(undefined, 'normal');
        const obs = doc.splitTextToSize(formData.get('observacoes'), 170);
        doc.text(obs, 20, y);
      }
      
      doc.save(`processo-${Date.now()}.pdf`);
      mostrarAlerta('alertCadastro', 'PDF exportado com sucesso!', 'success');
      setTimeout(() => {
        document.getElementById('alertCadastro').innerHTML = '';
      }, 3000);
    });

    // ========== LISTA DE PROCESSOS ==========
    let processosFiltrados = [];
    let ordenacaoData = 'desc';

    function renderizarTabela(filtro = '') {
      const processos = carregarProcessos();
      processosFiltrados = processos.filter(p => {
        if (!filtro) return true;
        const busca = filtro.toLowerCase();
        return (
          p.nome.toLowerCase().includes(busca) ||
          (p.cpf && p.cpf.includes(busca)) ||
          (p.numero && p.numero.includes(busca)) ||
          (p.categoria && p.categoria.toLowerCase().includes(busca))
        );
      });
      
      const wrapper = document.getElementById('tableWrapper');
      
      if (processosFiltrados.length === 0) {
        wrapper.innerHTML = '<div class="no-data">Nenhum processo encontrado.</div>';
        return;
      }
      
      let html = '<table><thead><tr>';
      html += '<th>Nome</th><th>Categoria</th><th>N√∫mero</th><th>Status</th><th>Data Abertura</th><th>Pagamento</th><th>A√ß√µes</th>';
      html += '</tr></thead><tbody>';
      
      processosFiltrados.forEach(p => {
        html += '<tr>';
        html += `<td>${p.nome}</td>`;
        html += `<td>${p.categoria || '-'}</td>`;
        html += `<td>${p.numero || '-'}</td>`;
        html += `<td>
          <select onchange="mudarStatus('${p.id}', this.value)" style="padding:6px 8px;font-size:13px;border:1px solid rgba(11,27,43,0.1);border-radius:6px;background:#fff">
            ${STATUS_OPTIONS.map(status => 
              `<option value="${status}" ${p.status === status ? 'selected' : ''}>${status}</option>`
            ).join('')}
          </select>
        </td>`;
        html += `<td>${p.dataAbertura ? new Date(p.dataAbertura).toLocaleDateString('pt-BR') : '-'}</td>`;
        html += `<td>${p.formaPagamento || '-'}${p.parcelas ? ` (${p.parcelas}x)` : ''}</td>`;
        html += `<td>
          <button class="btn ghost" onclick="verDetalhes('${p.id}')">
            <span class="material-icons">visibility</span> Ver
          </button>
          <button class="btn danger" onclick="deletarProcesso('${p.id}')">
            <span class="material-icons">delete</span>
          </button>
        </td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      wrapper.innerHTML = html;
    }

    // Mudar status
    window.mudarStatus = function(id, novoStatus) {
      const processos = carregarProcessos();
      const processo = processos.find(p => p.id === id);
      if (processo) {
        processo.status = novoStatus;
        salvarProcessos(processos);
        console.log(`Status do processo ${id} alterado para: ${novoStatus}`);
      }
    };

    // Busca
    document.getElementById('searchInput').addEventListener('input', (e) => {
      renderizarTabela(e.target.value);
    });

    // Atualizar
    document.getElementById('btnRefresh').addEventListener('click', () => {
      renderizarTabela();
    });

    // Ordenar por data
    document.getElementById('btnSortDate').addEventListener('click', () => {
      const processos = carregarProcessos();
      ordenacaoData = ordenacaoData === 'desc' ? 'asc' : 'desc';
      
      processos.sort((a, b) => {
        const dataA = new Date(a.dataAbertura || a.dataCadastro);
        const dataB = new Date(b.dataAbertura || b.dataCadastro);
        return ordenacaoData === 'desc' ? dataB - dataA : dataA - dataB;
      });
      
      salvarProcessos(processos);
      renderizarTabela();
    });

    // Download CSV
    document.getElementById('btnDownloadCsv').addEventListener('click', () => {
      const processos = processosFiltrados.length > 0 ? processosFiltrados : carregarProcessos();
      
      if (processos.length === 0) {
        alert('Nenhum processo para exportar.');
        return;
      }
      
      let csv = 'Nome,CPF,Telefone,Email,Categoria,N√∫mero,Status,Data Abertura,Valor,Honor√°rios,Forma Pagamento,Parcelas\n';
      
      processos.forEach(p => {
        csv += `"${p.nome}","${p.cpf || ''}","${p.telefone || ''}","${p.email || ''}","${p.categoria || ''}","${p.numero || ''}","${p.status}","${p.dataAbertura || ''}","${p.valor || ''}","${p.honorarios || ''}","${p.formaPagamento || ''}","${p.parcelas || ''}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `processos-${Date.now()}.csv`;
      link.click();
    });

    // Ver detalhes
    window.verDetalhes = function(id) {
      const processos = carregarProcessos();
      const processo = processos.find(p => p.id === id);
      if (!processo) return;
      
      let detalhes = 'DETALHES DO PROCESSO\n\n';
      detalhes += `Nome: ${processo.nome}\n`;
      detalhes += `CPF: ${processo.cpf || '-'}\n`;
      detalhes += `RG: ${processo.rg || '-'}\n`;
      detalhes += `Telefone: ${processo.telefone || '-'}\n`;
      detalhes += `Email: ${processo.email || '-'}\n`;
      detalhes += `Respons√°vel: ${processo.responsavel || '-'}\n`;
      detalhes += `Endere√ßo: ${processo.endereco || '-'}\n`;
      detalhes += `Categoria: ${processo.categoria || '-'}\n`;
      detalhes += `N√∫mero: ${processo.numero || '-'}\n`;
      detalhes += `Vara: ${processo.vara || '-'}\n`;
      detalhes += `Parte Contr√°ria: ${processo.parte || '-'}\n`;
      detalhes += `Status: ${processo.status}\n`;
      detalhes += `Data Abertura: ${processo.dataAbertura || '-'}\n`;
      detalhes += `Valor da Causa: R$ ${processo.valor || '0'}\n`;
      detalhes += `Honor√°rios: R$ ${processo.honorarios || '0'}\n`;
      detalhes += `Forma de Pagamento: ${processo.formaPagamento || '-'}\n`;
      detalhes += `Parcelas: ${processo.parcelas || '-'}\n`;
      detalhes += `Observa√ß√µes: ${processo.observacoes || '-'}\n`;
      
      alert(detalhes);
    };

    // Deletar processo
    window.deletarProcesso = function(id) {
      if (!confirm('Deseja realmente deletar este processo?')) return;
      
      let processos = carregarProcessos();
      processos = processos.filter(p => p.id !== id);
      salvarProcessos(processos);
      
      renderizarTabela();
    };

    // ========== ANOTA√á√ïES ==========
    function atualizarSelectProcessos() {
      const processos = carregarProcessos();
      const select = document.getElementById('selectProcesso');
      
      select.innerHTML = '<option value="">--- selecione um processo ---</option>';
      
      processos.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.nome} - ${p.numero || 'S/N'}`;
        select.appendChild(option);
      });
    }

    function renderizarAnotacoes() {
      const processoId = document.getElementById('selectProcesso').value;
      const container = document.getElementById('listaAnotacoes');
      
      if (!processoId) {
        container.innerHTML = '<div class="no-data">Selecione um processo para ver as anota√ß√µes.</div>';
        return;
      }
      
      const anotacoes = carregarAnotacoes().filter(a => a.processoId === processoId);
      
      if (anotacoes.length === 0) {
        container.innerHTML = '<div class="no-data">Nenhuma anota√ß√£o para este processo.</div>';
        return;
      }
      
      let html = '';
      anotacoes.forEach(a => {
        html += `<div class="note-card">
          <div class="note-meta">${new Date(a.data).toLocaleString('pt-BR')}</div>
          <div class="note-text">${a.texto}</div>
          <button class="btn danger" onclick="deletarAnotacao('${a.id}')" style="margin-top:8px;font-size:12px;padding:4px 8px">
            <span class="material-icons" style="font-size:16px">delete</span> Excluir
          </button>
        </div>`;
      });
      
      container.innerHTML = html;
    }

    document.getElementById('selectProcesso').addEventListener('change', renderizarAnotacoes);

    document.getElementById('btnSalvarAnotacao').addEventListener('click', () => {
      const processoId = document.getElementById('selectProcesso').value;
      const texto = document.getElementById('inputAnotacao').value.trim();
      
      if (!processoId) {
        mostrarAlerta('alertAnotacoes', 'Selecione um processo primeiro.', 'error');
        return;
      }
      
      if (!texto) {
        mostrarAlerta('alertAnotacoes', 'Digite uma anota√ß√£o.', 'error');
        return;
      }
      
      const anotacoes = carregarAnotacoes();
      anotacoes.push({
        id: Date.now().toString(),
        processoId,
        texto,
        data: new Date().toISOString()
      });
      
      salvarAnotacoes(anotacoes);
      document.getElementById('inputAnotacao').value = '';
      renderizarAnotacoes();
      mostrarAlerta('alertAnotacoes', 'Anota√ß√£o salva com sucesso!', 'success');
      
      setTimeout(() => {
        document.getElementById('alertAnotacoes').innerHTML = '';
      }, 3000);
    });

    window.deletarAnotacao = function(id) {
      if (!confirm('Deseja realmente excluir esta anota√ß√£o?')) return;
      
      let anotacoes = carregarAnotacoes();
      anotacoes = anotacoes.filter(a => a.id !== id);
      salvarAnotacoes(anotacoes);
      renderizarAnotacoes();
    };

    // ========== CALCULADORA DE PRAZOS ==========
    document.getElementById('btnCalcularPrazo').addEventListener('click', () => {
      const dataInicial = document.getElementById('dataInicial').value;
      const tipoPrazo = document.getElementById('tipoPrazo').value;
      const quantidade = parseInt(document.getElementById('quantidadeDias').value);
      
      if (!dataInicial || !quantidade) {
        alert('Preencha a data inicial e a quantidade de dias.');
        return;
      }
      
      const data = new Date(dataInicial + 'T00:00:00');
      let diasAdicionados = 0;
      
      if (tipoPrazo === 'corrido') {
        data.setDate(data.getDate() + quantidade);
        diasAdicionados = quantidade;
      } else {
        // Dias √∫teis (n√£o considera feriados)
        while (diasAdicionados < quantidade) {
          data.setDate(data.getDate() + 1);
          const diaSemana = data.getDay();
          if (diaSemana !== 0 && diaSemana !== 6) {
            diasAdicionados++;
          }
        }
      }
      
      const resultado = document.getElementById('resultadoPrazo');
      const texto = document.getElementById('resultadoTexto');
      
      texto.innerHTML = `
        <strong>Data Final:</strong> ${data.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}<br>
        <strong>Prazo:</strong> ${quantidade} ${tipoPrazo === 'corrido' ? 'dias corridos' : 'dias √∫teis'}
      `;
      
      resultado.style.display = 'block';
    });

    // ========== LIMPAR TODOS OS DADOS ==========
    document.getElementById('btnLimparTodos').addEventListener('click', () => {
      if (!confirm('ATEN√á√ÉO: Isso ir√° apagar TODOS os processos e anota√ß√µes. Deseja continuar?')) return;
      if (!confirm('Tem certeza? Esta a√ß√£o n√£o pode ser desfeita!')) return;
      
      localStorage.removeItem(DB_KEY);
      localStorage.removeItem(NOTES_KEY);
      
      alert('Todos os dados foram removidos com sucesso.');
      renderizarTabela();
      renderizarAnotacoes();
    });

    // ========== UTILIT√ÅRIOS ==========
    function mostrarAlerta(containerId, mensagem, tipo) {
      const container = document.getElementById(containerId);
      container.innerHTML = `<div class="alert ${tipo}">${mensagem}</div>`;
    }

    // Inicializar ao carregar
    renderizarTabela();
  </script>
</body>
</html>
