function doGet(e) {
  const action = e.parameter.action;

  try {
    switch (action) {
      case "listarProcessos":
        return listarProcessos();
      case "buscarAnotacoes":
        return buscarAnotacoes(e);
      case "buscarHistorico":
        return buscarHistorico(e);
      default:
        return ContentService
          .createTextOutput(JSON.stringify({ erro: "Ação inválida." }))
          .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ erro: err.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  const data = e.parameter;
  const action = data.action;

  try {
    switch (action) {
      case "cadastrarProcesso":
        return cadastrarProcesso(data);
      case "registrarAnotacao":
        return registrarAnotacao(data);
      default:
        return ContentService
          .createTextOutput(JSON.stringify({ erro: "Ação POST inválida." }))
          .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ erro: err.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/* === CONFIGURAÇÕES === */
const NOME_PLANILHA = "Processos";
const NOME_ANOTACOES = "Anotacoes";

/* === CADASTRAR PROCESSO === */
function cadastrarProcesso(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(NOME_PLANILHA);
  
  if (!sheet) throw new Error(`A aba '${NOME_PLANILHA}' não existe.`);

  const linha = [
    new Date(),
    data.nome || "",
    data.cpf || "",
    data.endereco || "",
    data.categoria || "",
    data.vara || "",
    data.numero || "",
    data.status || "",
    data.observacoes || ""
  ];
  
  sheet.appendRow(linha);
  
  return ContentService
    .createTextOutput(JSON.stringify({ sucesso: true }))
    .setMimeType(ContentService.MimeType.JSON);
}

/* === LISTAR PROCESSOS === */
function listarProcessos() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(NOME_PLANILHA);
  
  if (!sheet) throw new Error(`A aba '${NOME_PLANILHA}' não existe.`);
  
  const dados = sheet.getDataRange().getValues();
  const cabecalho = dados.shift();
  
  const processos = dados.map(r => ({
    dataCadastro: r[0],
    nome: r[1],
    cpf: r[2],
    endereco: r[3],
    categoria: r[4],
    vara: r[5],
    numero: r[6],
    status: r[7],
    observacoes: r[8]
  }));
  
  return ContentService
    .createTextOutput(JSON.stringify(processos))
    .setMimeType(ContentService.MimeType.JSON);
}

/* === REGISTRAR ANOTAÇÃO === */
function registrarAnotacao(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(NOME_ANOTACOES);
  
  if (!sheet) throw new Error(`A aba '${NOME_ANOTACOES}' não existe.`);

  const linha = [
    new Date(),
    data.numero || "",
    data.texto || "",
    new Date().toLocaleString("pt-BR")
  ];
  
  sheet.appendRow(linha);
  
  return ContentService
    .createTextOutput(JSON.stringify({ sucesso: true }))
    .setMimeType(ContentService.MimeType.JSON);
}

/* === BUSCAR ANOTAÇÕES === */
function buscarAnotacoes(e) {
  const numero = e.parameter.numero;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(NOME_ANOTACOES);
  
  if (!sheet) throw new Error(`A aba '${NOME_ANOTACOES}' não existe.`);
  
  const dados = sheet.getDataRange().getValues();
  const cabecalho = dados.shift();

  const anotacoes = dados
    .filter(r => r[1] == numero)
    .map(r => ({
      dataRegistro: r[0],
      numero: r[1],
      texto: r[2],
      dataHora: r[3]
    }));
  
  return ContentService
    .createTextOutput(JSON.stringify(anotacoes))
    .setMimeType(ContentService.MimeType.JSON);
}

/* === BUSCAR HISTÓRICO COMPLETO === */
function buscarHistorico(e) {
  const cpf = e.parameter.cpf;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(NOME_PLANILHA);
  
  if (!sheet) throw new Error(`A aba '${NOME_PLANILHA}' não existe.`);

  const dados = sheet.getDataRange().getValues();
  const cabecalho = dados.shift();

  const processos = dados
    .filter(r => r[2] == cpf)
    .map(r => ({
      dataCadastro: r[0],
      nome: r[1],
      cpf: r[2],
      endereco: r[3],
      categoria: r[4],
      vara: r[5],
      numero: r[6],
      status: r[7],
      observacoes: r[8]
    }));

  return ContentService
    .createTextOutput(JSON.stringify(processos))
    .setMimeType(ContentService.MimeType.JSON);
}
