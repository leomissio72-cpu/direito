<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema Jurídico</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root{
            --bg:#f4f6fb;
            --sidebar:#0f1724;
            --card:#ffffff;
            --muted:#556179;
            --primary:#3366ff;
            --accent:#2b61ff;
            --success:#0ea44e;
            --warning:#f59e0b;
            --danger:#ef4444;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:#0b1b2b}
        
        /* 1. O SISTEMA COMPLETO COMEÇA OCULTO */
        .app{display:none;min-height:100vh}

        /* 2. CARD DE LOGIN CENTRALIZADO (visível se .app estiver oculto) */
        .login-screen{
            display:flex;align-items:center;justify-content:center;height:100vh;
            background:var(--bg);
        }
        .login-card-content{
            background:var(--card);padding:32px;border-radius:12px;
            box-shadow:0 8px 30px rgba(11,27,43,0.08);width:360px;text-align:center;
        }
        .btn-auth{
            display:flex;align-items:center;justify-content:center;gap:8px;
            padding:12px;border-radius:8px;border:none;cursor:pointer;
            font-weight:700;margin-top:10px;
        }
        .btn-google{background:#4285F4;color:#fff;}
        .btn-microsoft{background:#0078D4;color:#fff;}
        .btn-logout{background:var(--danger);color:#fff;margin-top:20px}

        /* SIDEBAR (seu estilo original) */
        .sidebar{width:220px;padding:20px;background:#0f1724;color:#fff;display:flex;flex-direction:column;gap:18px;}
        /* ... (Restante do seu CSS permanece o mesmo) ... */
    </style>
</head>

<body>
    <div id="loginGate" class="login-screen">
        <div class="login-card-content">
            <div id="loadingMessage">
                <h3>Verificando Acesso...</h3>
                <p style="color:var(--muted)">Aguarde enquanto carregamos o estado da sua sessão.</p>
            </div>
            
            <div id="authButtons" style="display:none">
                <h3>Acesso Restrito</h3>
                <p style="color:var(--muted)">Faça login para continuar.</p>
                <button class="btn-auth btn-google" id="btnGoogle"><span class="material-icons">login</span> Entrar com Google</button>
                <button class="btn-auth btn-microsoft" id="btnMicrosoft"><span class="material-icons">login</span> Entrar com Microsoft</button>
            </div>
        </div>
    </div>

    <div class="app" id="mainApp">
        <aside class="sidebar">
            </aside>

        <div class="workspace">
            <div class="topbar">
                <div class="user-area">
                    <div style="text-align:right">
                        <div id="userName" style="font-weight:700"></div>
                        <div style="font-size:12px;color:var(--muted)">
                            <a href="#" id="btnLogout" class="btn-logout" style="text-decoration:none;display:block;padding:4px 8px;font-size:12px">Sair</a>
                        </div>
                    </div>
                    <div class="avatar" id="userAvatar">⚖️</div>
                </div>
            </div>

            <main class="main-area">
                <section id="cadastro" class="container tab" style="display:block">
                    </section>
                <section id="lista" class="container tab" style="display:none">
                    </section>
                <section id="anotacoes" class="container tab" style="display:none">
                    </section>
                <section id="ferramentas" class="container tab" style="display:none">
                    </section>
            </main>
        </div>
    </div>

    <script src="firebase-config.js"></script>

    <script type="module">
        // Importa as funções do SDK Modular
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, OAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // NOTA: firebaseConfig é carregada do firebase-config.js
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrWzlAEW-f93fdVd4mCc-XaI6GlBQ_0luuDA-OV8oslGPfACLi69P7so9o4-YS3Lo2Cw/exec";
        const SHEET_CSV = "https://docs.google.com/spreadsheets/d/1wU3D0kSBjAB_lIKKi1fUP9LZJK8pto2l7byvZBwucOM/export?format=csv&gid=0";
        
        // Elementos de controle
        const loginGate = document.getElementById('loginGate');
        const mainApp = document.getElementById('mainApp');
        const loadingMessage = document.getElementById('loadingMessage');
        const authButtons = document.getElementById('authButtons');
        const userNameEl = document.getElementById('userName');
        const userAvatarEl = document.getElementById('userAvatar');
        
        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        /* -----------------------------
           GATE DE AUTENTICAÇÃO
           ----------------------------- */
        onAuthStateChanged(auth, user => {
            loadingMessage.style.display = 'none'; // Esconde a mensagem "Verificando Acesso..."

            if (user) {
                // USUÁRIO LOGADO: MOSTRA O PAINEL
                loginGate.style.display = 'none';
                mainApp.style.display = 'flex'; // Torna o sistema visível
                
                userNameEl.innerText = user.displayName || (user.email || 'Usuário');
                if (user.photoURL) userAvatarEl.innerHTML = `<img src="${user.photoURL}" style="width:100%;height:100%;border-radius:8px"/>`;

                // Chama a inicialização dos dados
                loadTable(); 
                populateProcessSelect(); 
                loadAnotacoes();

            } else {
                // USUÁRIO NÃO LOGADO: MOSTRA BOTÕES DE LOGIN
                loginGate.style.display = 'flex';
                mainApp.style.display = 'none';
                authButtons.style.display = 'block';
                userNameEl.innerText = 'Convidado';
            }
        });

        /* -----------------------------
           FUNÇÕES DE LOGIN
           ----------------------------- */
        document.getElementById('btnGoogle').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(e => alert('Erro ao logar: ' + e.message));
        });

        document.getElementById('btnMicrosoft').addEventListener('click', () => {
            const provider = new OAuthProvider('microsoft.com');
            signInWithPopup(auth, provider).catch(e => alert('Erro ao logar MS: ' + e.message));
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
            signOut(auth).then(() => {
                alert('Sessão encerrada.');
            }).catch(e => alert('Erro ao sair: ' + e.message));
        });
        
        /* -----------------------------
           (O restante das suas funções JS: nowReadable, parseCSV, loadTable, etc.)
           (Você deve colar todo o restante do JS original aqui)
           ----------------------------- */
    </script>
</body>
</html>
